# 実装プラン：ローカル写真ブラウザ Web アプリ

---

## 概要

本ドキュメントは、`requirements.md`（要件定義書）および `design.md`（設計書）に基づく実装プランである。
実装はフェーズ単位で進め、各フェーズの完了後に動作確認を行う。

---

## 現在の実装状況

以下のファイルが既に作成済みであり、基本的なコード構造は完成している。

### バックエンド（作成済み）
- `backend/main.py` - FastAPI アプリ定義・サーバ起動
- `backend/config.py` - パス設定
- `backend/database.py` - SQLite + SQLAlchemy セッション管理
- `backend/models/` - 全 4 モデル（photo, person_tag, photo_person, setting）
- `backend/schemas/` - 全 Pydantic スキーマ
- `backend/routers/` - 全 6 ルーター（photos, images, favorites, tags, scan, settings）
- `backend/services/` - 全 3 サービス（scanner, thumbnail, exif）
- `backend/requirements.txt` - Python 依存パッケージ

### フロントエンド（作成済み）
- `frontend/src/main.tsx` - React エントリーポイント
- `frontend/src/App.tsx` - ルーティング
- `frontend/src/api/client.ts` - API クライアント
- `frontend/src/types/index.ts` - TypeScript 型定義
- `frontend/src/stores/appStore.ts` - Zustand ストア
- `frontend/src/hooks/` - 全 6 カスタムフック
- `frontend/src/pages/` - 全 4 ページ
- `frontend/src/components/` - 全 UI コンポーネント
- `frontend/package.json` - NPM 依存パッケージ
- `frontend/vite.config.ts` - Vite 設定

### その他
- `scripts/start.py` - 起動スクリプト

---

## 実装フェーズ

### フェーズ 0: 環境構築・動作確認
**目標:** 開発環境をセットアップし、既存コードが正常に動作するか確認する

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 0-1 | Python 仮想環境構築 | `python -m venv venv` でバックエンド用の仮想環境を作成 | `venv/` ディレクトリが生成される |
| 0-2 | バックエンド依存パッケージインストール | `pip install -r backend/requirements.txt` | エラーなく完了 |
| 0-3 | フロントエンド依存パッケージインストール | `cd frontend && npm install` | `node_modules/` が生成される |
| 0-4 | バックエンド起動確認 | `python -m uvicorn backend.main:app` | http://localhost:8000/docs でSwagger UI表示 |
| 0-5 | フロントエンド起動確認 | `cd frontend && npm run dev` | http://localhost:5173 でUI表示 |
| 0-6 | 既存コードのレビュー・問題点洗い出し | 全ファイルの整合性・構文エラーチェック | コンパイルエラーなし |

**完了条件:** バックエンド・フロントエンドが両方起動し、画面が表示される

---

### フェーズ 1: バックエンド基盤（DB・設定・スキャン）
**目標:** データベースの初期化、設定管理、フォルダスキャンが正常に動作する

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 1-1 | DB 初期化動作確認 | サーバ起動時に SQLite ファイル・テーブルが自動生成されるか | `data/photos.db` が生成される |
| 1-2 | 設定 API 動作確認 | GET/PUT /api/settings の動作検証 | Swagger UI or curl で確認 |
| 1-3 | スキャン API 動作確認 | POST /api/scan でフォルダスキャンが実行されるか | 写真ファイルが DB に登録される |
| 1-4 | スキャン進捗 API 確認 | GET /api/scan/status でスキャン状態取得 | scanning/completed の状態遷移 |
| 1-5 | EXIF 情報取得確認 | スキャン時に撮影日が正しく抽出されるか | taken_at カラムに値が入る |
| 1-6 | 差分スキャン確認 | 再スキャン時に追加/削除が正しく反映されるか | ファイル追加・削除後に再スキャン |

**完了条件:** フォルダ指定→スキャン→DB 反映の一連のフローが動作する

---

### フェーズ 2: 画像配信・サムネイル
**目標:** フル画像およびサムネイルの配信が正常に動作する

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 2-1 | フル画像配信確認 | GET /api/images/{id}/full で画像が返されるか | ブラウザで画像表示 |
| 2-2 | サムネイル生成確認 | GET /api/images/{id}/thumbnail でサムネイルが生成・返却されるか | thumbnails/ にファイル生成 |
| 2-3 | サムネイルキャッシュ確認 | 2回目のアクセスでキャッシュが使われるか | ファイル再生成されない |
| 2-4 | キャッシュクリア確認 | POST /api/settings/clear-cache でサムネイルが削除されるか | thumbnails/ が空になる |

**完了条件:** 画像とサムネイルの配信・キャッシュが正常動作する

---

### フェーズ 3: 写真一覧・ソート・フィルタ API
**目標:** 写真の一覧取得、ソート、フィルタリングが正しく動作する

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 3-1 | 写真一覧 API 確認 | GET /api/photos でページネーション付き一覧取得 | JSON レスポンスの件数・ページ情報 |
| 3-2 | ソート確認 | sort_by=created_at/modified_at/taken_at/file_name/random | 順序が正しいか |
| 3-3 | お気に入りフィルタ確認 | favorite_only=true で絞り込み | お気に入りのみ返却 |
| 3-4 | 人物タグフィルタ確認 | person_tag_id={id} で絞り込み | 該当タグの写真のみ返却 |
| 3-5 | ランダム取得確認 | GET /api/photos/random | 毎回異なる写真が返却 |
| 3-6 | 前後写真取得確認 | GET /api/photos/{id}/neighbors | prev/next が正しい |

**完了条件:** 全ソート・フィルタ組み合わせが正しく動作する

---

### フェーズ 4: お気に入り・タグ API
**目標:** お気に入りと人物タグの CRUD が正常に動作する

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 4-1 | お気に入りトグル確認 | PUT /api/photos/{id}/favorite | is_favorite が切り替わる |
| 4-2 | タグ作成確認 | POST /api/tags | DB にタグが追加される |
| 4-3 | タグ一覧確認 | GET /api/tags | 写真数付きで一覧取得 |
| 4-4 | タグ名変更確認 | PUT /api/tags/{id} | 名前が更新される |
| 4-5 | タグ削除確認 | DELETE /api/tags/{id} | 関連レコードも削除される |
| 4-6 | 写真へのタグ付与確認 | POST /api/photos/{id}/tags | photo_persons に追加 |
| 4-7 | 写真からのタグ削除確認 | DELETE /api/photos/{id}/tags/{tag_id} | photo_persons から削除 |
| 4-8 | 永続化確認 | サーバ再起動後もデータが保持されるか | DB ファイルにデータが残る |

**完了条件:** お気に入り・タグの全 CRUD 操作が正常に動作し、永続化される

---

### フェーズ 5: フロントエンド - グリッド画面
**目標:** 写真のサムネイル一覧が正しく表示され、操作できる

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 5-1 | グリッド表示確認 | サムネイルが格子状に並ぶ | UI 表示 |
| 5-2 | ページネーション確認 | スクロール or ページ送りで次の写真が読み込まれる | 追加写真の表示 |
| 5-3 | ソート切替確認 | SortBar の操作でソート順が変わる | 表示順の変化 |
| 5-4 | フィルタ切替確認 | FilterBar でお気に入り/人物タグフィルタが動作 | 表示内容の変化 |
| 5-5 | カード押下で遷移確認 | サムネイルクリックで ViewerPage へ遷移 | URL が /viewer/{id} に変化 |
| 5-6 | レスポンシブ確認 | ウィンドウサイズ変更時のグリッド調整 | 列数が変化する |

**完了条件:** グリッド画面で写真一覧の閲覧・ソート・フィルタが可能

---

### フェーズ 6: フロントエンド - ビューア画面
**目標:** 写真の1枚表示、ナビゲーション、各種操作ができる

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 6-1 | 1枚表示確認 | 画像がフィットサイズで表示される | UI 表示 |
| 6-2 | 前後ナビゲーション確認 | 前へ/次へボタンで写真が切り替わる | 画像の変化 |
| 6-3 | キーボードナビゲーション確認 | 矢印キーで操作 | キー入力で反応 |
| 6-4 | ランダム表示確認 | ランダムボタンでランダムな写真に切替 | 異なる写真が表示 |
| 6-5 | ズーム確認 | ズームイン/アウトの動作 | 拡大・縮小の変化 |
| 6-6 | お気に入りトグル確認 | ハートボタンでお気に入りON/OFF | アイコンの変化 |
| 6-7 | タグ管理確認 | タグの追加/削除が動作 | タグリストの変化 |
| 6-8 | スライドショー確認 | 開始/停止で自動切替が動作 | 指定間隔で写真が自動切替 |
| 6-9 | Space キーでスライドショー切替 | キーボードショートカット | 開始/停止が切り替わる |
| 6-10 | Escape でグリッドに戻る | キーボードショートカット | GridPage に遷移 |

**完了条件:** ビューア画面の全機能（表示・ナビ・お気に入り・タグ・スライドショー・ズーム）が動作

---

### フェーズ 7: フロントエンド - 人物一覧・設定画面
**目標:** 人物タグ管理と設定画面が正しく動作する

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 7-1 | 人物タグ一覧表示確認 | タグが写真数付きで表示 | UI 表示 |
| 7-2 | タグ選択で絞り込み確認 | タグクリックでグリッド画面にフィルタ遷移 | フィルタされた一覧表示 |
| 7-3 | タグ名変更確認 | リネームダイアログで名前変更 | 一覧に反映 |
| 7-4 | タグ削除確認 | 確認ダイアログ付きで削除 | 一覧から消える |
| 7-5 | フォルダ設定確認 | ルートフォルダの変更 | 設定が保存される |
| 7-6 | スキャン実行確認 | スキャンボタンで進捗表示 | プログレス → 完了 |
| 7-7 | スライド間隔設定確認 | 間隔値の変更が反映される | スライドショー速度の変化 |
| 7-8 | キャッシュクリア確認 | サムネイルキャッシュの削除 | サムネイルが再生成される |
| 7-9 | DB リセット確認 | データベースの初期化 | お気に入り・タグがクリア |

**完了条件:** 人物一覧画面と設定画面の全機能が動作する

---

### フェーズ 8: 結合テスト・MVP 完了確認
**目標:** 全機能の結合テストを行い、MVP 完了条件を満たすことを確認する

| # | タスク | 詳細 | 確認方法 |
|---|-------|------|---------|
| 8-1 | E2E フロー: 初期セットアップ | フォルダ指定 → スキャン → グリッド表示 | 一連の操作が完了 |
| 8-2 | E2E フロー: ランダム表示 | 全体ランダム / 人物絞り込みランダム / お気に入りランダム | 3パターンすべて動作 |
| 8-3 | E2E フロー: タグ操作 | タグ作成 → 写真に付与 → フィルタ → ランダム | 一連の操作が完了 |
| 8-4 | E2E フロー: お気に入り操作 | お気に入り登録 → フィルタ → スライドショー | 一連の操作が完了 |
| 8-5 | 永続化確認 | サーバ再起動後にお気に入り・タグが保持される | データが残っている |
| 8-6 | ソート確認 | 作成日順、更新日順、ファイル名順、ランダム | 全ソートが正しい |
| 8-7 | セキュリティ確認 | localhost のみ待ち受け、外部通信なし | ネットワーク確認 |
| 8-8 | パフォーマンス確認 | 写真枚数が多い場合のレスポンス時間 | 体感で問題ないレベル |

**完了条件（= MVP 完了条件）:**
- [x] フォルダを指定して写真を表示できる
- [x] ランダム表示ができる（全体 / 人物絞り込み / お気に入り内）
- [x] 人物タグ付けとお気に入りが永続化される（再起動後も保持）
- [x] 作成日順などのソートができる
- [x] localhost のみで動作し、外部通信を行わない

---

## 実装順序の方針

```
フェーズ 0: 環境構築・動作確認
    ↓
フェーズ 1: バックエンド基盤（DB・設定・スキャン）
    ↓
フェーズ 2: 画像配信・サムネイル
    ↓
フェーズ 3: 写真一覧・ソート・フィルタ API
    ↓
フェーズ 4: お気に入り・タグ API
    ↓
フェーズ 5: フロントエンド - グリッド画面
    ↓
フェーズ 6: フロントエンド - ビューア画面
    ↓
フェーズ 7: フロントエンド - 人物一覧・設定画面
    ↓
フェーズ 8: 結合テスト・MVP 完了確認
```

**方針:**
1. バックエンド API を先に完成・検証してからフロントエンドに着手する
2. 各フェーズで動作確認を行い、問題があれば次フェーズに進む前に修正する
3. 既存コードの構文・ロジックに問題があれば、該当フェーズで修正する

---

## 注意事項・リスク

| リスク | 影響 | 対策 |
|-------|------|------|
| 大量写真でのスキャン時間 | 初回スキャンが長時間化 | バッチコミット・進捗表示で体感改善 |
| EXIF 未対応フォーマット | 撮影日が取得できない | taken_at が NULL の場合は created_at にフォールバック |
| サムネイル生成コスト | 初回アクセス時の遅延 | オンデマンド生成 + キャッシュで2回目以降は高速化 |
| Windows パス区切り文字 | `/` と `\` の混在 | pathlib.Path で統一的に処理 |
| ブラウザキャッシュ | 古い画像が表示される | 適切な Cache-Control ヘッダの設定 |
